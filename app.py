import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
st.set_page_config(page_title="Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠ", layout="wide")

# 2. Ø¨Ù†Ø§Ø¡ "Ø¹Ù‚Ù„" Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„)
if 'db' not in st.session_state:
    # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø²Ù†
    prods = ['Cola 330ml', 'Cola 1.5L', 'Water 500ml', 'Flour 5kg', 'Pasta']
    whs = ['Ù…Ø³ØªÙˆØ¯Ø¹ Ø¯Ø¨ÙŠ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ', 'Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø´Ø§Ø±Ù‚Ø©']
    inv = []
    for p in prods:
        for w in whs:
            # ØªÙˆÙ„ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù‚Ø¹ÙŠØ© (Ø¨Ø¹Ø¶Ù‡Ø§ Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹ Ù„Ø¥Ø«Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø´)
            inv.append({'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹': w, 'Ø§Ù„Ù…Ù†ØªØ¬': p, 'Ø§Ù„Ø±ØµÙŠØ¯': np.random.randint(50, 4000)})
    
    # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    drivers = ['Ø³Ø¹ÙŠØ¯ Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'Ø¬Ø§Ø³Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', 'Ø®Ø§Ù„Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†']
    orders = []
    for i in range(1, 31):
        orders.append({
            'Ø§Ù„Ø¹Ù…ÙŠÙ„': f'Ø¹Ù…ÙŠÙ„ {i}',
            'Ø§Ù„Ø£Ù‡Ù…ÙŠØ©': np.random.choice(['AAA (Ø£Ù‡Ù…ÙŠØ© Ù‚ØµÙˆÙ‰)', 'AA (Ø¹Ø§Ù„ÙŠØ©)', 'A (Ø¹Ø§Ø¯ÙŠ)']),
            'Ø§Ù„Ø­Ø§Ù„Ø©': np.random.choice(['ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…', 'Ù…ØªØ£Ø®Ø± ğŸ”´', 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸšš']),
            'Ø§Ù„Ø´Ø§Ø­Ù†Ø©': f'TRK-{100+i}',
            'Ø§Ù„Ø³Ø§Ø¦Ù‚': np.random.choice(drivers),
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': np.random.choice(['Ø¯Ø¨ÙŠ', 'Ø£Ø¨ÙˆØ¸Ø¨ÙŠ', 'Ø§Ù„Ø´Ø§Ø±Ù‚Ø©'])
        })
    
    st.session_state.df_inv = pd.DataFrame(inv)
    st.session_state.df_orders = pd.DataFrame(orders)
    st.session_state.messages = [] # Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
    st.session_state.db = True

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ChatGPT Style) ---
with st.sidebar:
    st.header("ğŸ‘¨â€ğŸ’¼ Ù…ÙˆØ¸Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")
    st.write("Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ù†Ø§Ù‚Ø´Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµÙ†Ø¹ ÙˆØ§Ù„Ø£Ø³Ø·ÙˆÙ„ Ù…Ø¹Ùƒ.")
    
    # Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if prompt := st.chat_input("ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ.. Ù…Ø«Ù„Ø§Ù‹: Ù…Ø§ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ"):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # --- Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ ---
        with st.chat_message("assistant"):
            txt = prompt.lower()
            df_inv = st.session_state.df_inv
            df_ord = st.session_state.df_orders
            
            # 1. ØªØ­Ù„ÙŠÙ„ Ø¹Ø§Ù… Ù„Ù„ÙˆØ¶Ø¹ (Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙŠØ©)
            if any(word in txt for word in ["Ø£Ù‡Ù„Ø§", "Ù…Ø±Ø­Ø¨Ø§", "Ù‡Ù„Ø§", "ÙƒÙŠÙ Ø§Ù„Ø­Ø§Ù„", "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ"]):
                delays = len(df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'Ù…ØªØ£Ø®Ø± ğŸ”´'])
                low_stock = len(df_inv[df_inv['Ø§Ù„Ø±ØµÙŠØ¯'] < 300])
                response = f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£Ø³ØªØ§Ø° Ø·Ø§Ø±Ù‚! Ø£Ù†Ø§ Ø¨Ø®ÙŠØ± ÙˆÙ…Ø³ØªØ¹Ø¯ Ù„Ù„Ø¹Ù…Ù„. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¸Ù‡Ø± Ø£Ù† Ù„Ø¯ÙŠÙ†Ø§ {delays} Ø´Ø­Ù†Ø§Øª Ù…ØªØ£Ø®Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙˆÙ‡Ù†Ø§Ùƒ {low_stock} Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØµÙ„Øª Ù„Ù…Ø³ØªÙˆÙ‰ Ø­Ø±Ø¬. Ø¨Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† Ù†Ø¨Ø¯Ø£ Ù†Ù‚Ø§Ø´Ù†Ø§ØŸ"
            
            # 2. Ù†Ù‚Ø§Ø´ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ§Ù„ØªØ£Ø®ÙŠØ±
            elif any(word in txt for word in ["Ø³Ø§Ø¦Ù‚", "Ø³ÙˆØ§Ù‚", "ØªØ£Ø®ÙŠØ±", "ØªØ£Ø®Ø±"]):
                delayed_df = df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'Ù…ØªØ£Ø®Ø± ğŸ”´']
                if not delayed_df.empty:
                    top_driver = delayed_df.iloc[0]
                    response = f"Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ©ØŒ Ù†Ø¹Ù… Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ØªØ£Ø®ÙŠØ±. Ø§Ù„Ø³Ø§Ø¦Ù‚ **{top_driver['Ø§Ù„Ø³Ø§Ø¦Ù‚']}** Ù…ØªØ£Ø®Ø± Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© **{top_driver['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']}**. \n\n"
                    response += "Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ ÙÙŠ Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø§ØªØŒ Ù†Ù†ØµØ­ Ø¨Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¢Ù„ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ÙØ¦Ø© (AAA) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ£Ø«Ø± Ø³Ù…Ø¹Ø© Ø§Ù„Ù…ØµÙ†Ø¹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†ÙŠ Ø­ØµØ± ÙƒØ§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†ØŸ"
                else:
                    response = "Ø£Ø¨Ø´Ø±ÙƒØŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ø¢Ù† Ù…Ù„ØªØ²Ù…ÙˆÙ† Ø¨Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠØ© ÙˆØ§Ù„ÙˆØ¶Ø¹ ØªØ­Øª Ø§Ù„Ø³ÙŠØ·Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹."

            # 3. Ù†Ù‚Ø§Ø´ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù†ÙˆØ§Ù‚Øµ
            elif any(word in txt for word in ["Ù†Ù‚Øµ", "Ù†ÙˆØ§Ù‚Øµ", "Ù…Ø®Ø²Ù†", "Ø¨Ø¶Ø§Ø¹Ø©"]):
                critical = df_inv[df_inv['Ø§Ù„Ø±ØµÙŠØ¯'] < 300]
                if not critical.empty:
                    response = "Ù„Ù‚Ø¯ ÙØ­ØµØª Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙÙˆØ±Ø§Ù‹. Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø£Ù† Ø§Ù„ÙˆØ¶Ø¹ ÙŠØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªØ§Ù„ÙŠØ©:\n\n"
                    for _, row in critical.head(3).iterrows():
                        response += f"â€¢ **{row['Ø§Ù„Ù…Ù†ØªØ¬']}** ÙÙŠ **{row['Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹']}** Ø±ØµÙŠØ¯Ù‡ {row['Ø§Ù„Ø±ØµÙŠØ¯']} ÙÙ‚Ø·! âš ï¸\n"
                    response += "\nğŸ’¡ **Ù†ØµÙŠØ­Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:** Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¹Ù…Ù„ 'Ù…Ù†Ø§Ù‚Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ©' Ù…Ù† Ù…Ø³ØªÙˆØ¯Ø¹ Ø¢Ø®Ø± Ø¨Ù‡ ÙˆÙØ±Ø©. Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø±Ø¤ÙŠØ© Ø§Ù‚ØªØ±Ø§Ø­ÙŠ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŸ"
                else:
                    response = "Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù…ØªØ§Ø² Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…ØªÙˆÙØ±Ø© ÙÙˆÙ‚ Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†."

            # 4. Ø±Ø¯ Ø¹Ø§Ù… ÙŠØ­Ø§ÙƒÙŠ ChatGPT
            else:
                response = "ÙÙ‡Ù…Øª Ø§Ù‡ØªÙ…Ø§Ù…Ùƒ. ÙƒÙˆÙ†ÙŠ Ù…Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªØ­Ù„ÙŠÙ„ (ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ØŒ ØªÙˆØ§Ø²Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ø£Ùˆ Ø­ØªÙ‰ Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ø£Ø²Ù…Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©). Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙŠ ØªØ´ØºÙ„ Ø¨Ø§Ù„Ùƒ Ø§Ù„Ø¢Ù†ØŸ"

            st.markdown(response)
            st.session_state.messages.append({"role": "assistant", "content": response})

# --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ) ---
st.markdown("<h1 style='text-align: center;'>ğŸ›ï¸ Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… </h1>", unsafe_allow_html=True)

# ØµÙ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
c1, c2, c3, c4 = st.columns(4)
c1.metric("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„", len(st.session_state.df_orders))
c2.metric("Ø´Ø§Ø­Ù†Ø§Øª Ù†Ø´Ø·Ø© ğŸšš", len(st.session_state.df_orders[st.session_state.df_orders['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸšš']))
c3.metric("ØªØ£Ø®ÙŠØ±Ø§Øª ğŸ”´", len(st.session_state.df_orders[st.session_state.df_orders['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'Ù…ØªØ£Ø®Ø± ğŸ”´']))
c4.metric("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙƒÙ„ÙŠ", f"{st.session_state.df_inv['Ø§Ù„Ø±ØµÙŠØ¯'].sum():,}")

st.markdown("---")
# Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
t1, t2, t3 = st.tabs(["ğŸš› Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†", "ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†", "ğŸ“ˆ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡"])

with t1:
    st.dataframe(st.session_state.df_orders, use_container_width=True)
with t2:
    st.dataframe(st.session_state.df_inv, use_container_width=True)
with t3:
    fig = px.bar(st.session_state.df_inv, x='Ø§Ù„Ù…Ù†ØªØ¬', y='Ø§Ù„Ø±ØµÙŠØ¯', color='Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', barmode='group', title="ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")
    st.plotly_chart(fig, use_container_width=True)