import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©
st.set_page_config(page_title="AI Strategic Consultant", layout="wide")

# 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†)
if 'db_init' not in st.session_state:
    prods = ['Cola 330ml', 'Cola 1.5L', 'Water 500ml', 'Flour 5kg', 'Pasta']
    whs = ['Ù…Ø³ØªÙˆØ¯Ø¹ Ø¯Ø¨ÙŠ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ', 'Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø´Ø§Ø±Ù‚Ø©']
    inv = []
    for p in prods:
        for w in whs:
            inv.append({'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹': w, 'Ø§Ù„Ù…Ù†ØªØ¬': p, 'Ø§Ù„Ø±ØµÙŠØ¯': np.random.randint(50, 4000)})
    
    drivers = ['Ø³Ø¹ÙŠØ¯ Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'Ø¬Ø§Ø³Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', 'Ø®Ø§Ù„Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†']
    cities = ['Ø¯Ø¨ÙŠ', 'Ø£Ø¨ÙˆØ¸Ø¨ÙŠ', 'Ø§Ù„Ø´Ø§Ø±Ù‚Ø©', 'Ø§Ù„Ø¹ÙŠÙ†', 'Ø§Ù„ÙØ¬ÙŠØ±Ø©']
    orders = []
    for i in range(1, 41):
        orders.append({
            'Ø§Ù„Ø¹Ù…ÙŠÙ„': f'Ø¹Ù…ÙŠÙ„ {i}',
            'Ø§Ù„Ø­Ø§Ù„Ø©': np.random.choice(['ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…', 'Ù…ØªØ£Ø®Ø± ğŸ”´', 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸšš']),
            'Ø§Ù„Ø³Ø§Ø¦Ù‚': np.random.choice(drivers),
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': np.random.choice(cities),
            'Ø§Ù„Ø£Ù‡Ù…ÙŠØ©': np.random.choice(['VIP (AAA)', 'High (AA)', 'Normal (A)']),
            'Ø§Ù„Ø´Ø§Ø­Ù†Ø©': f'TRK-{100+i}'
        })
    st.session_state.df_inv = pd.DataFrame(inv)
    st.session_state.df_orders = pd.DataFrame(orders)
    st.session_state.chat_history = [] 
    st.session_state.db_init = True

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ©
df_ord = st.session_state.df_orders
df_inv = st.session_state.df_inv

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ (Open AI Style) ---
with st.sidebar:
    st.title("ğŸ¤– Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ AI")
    st.markdown("---")
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠ
    for msg in st.session_state.chat_history:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    if prompt := st.chat_input("ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ.. Ø§Ø³Ø£Ù„ Ø¹Ù† Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù†ØµÙŠØ­Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©"):
        st.session_state.chat_history.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        with st.chat_message("assistant"):
            q = prompt.lower()
            
            # 1. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¯Ù‚Ø©
            delayed = df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'Ù…ØªØ£Ø®Ø± ğŸ”´']
            low_stock = df_inv[df_inv['Ø§Ù„Ø±ØµÙŠØ¯'] < 400]
            
            # --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­ ---
            
            # Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ØªØ£Ø®ÙŠØ± (Ù…Ø¨Ø§Ø´Ø± ÙˆØªØ­Ù„ÙŠÙ„ÙŠ)
            if any(word in q for word in ["Ø£ÙŠÙ†", "ØªØ§Ø®ÙŠØ±", "ØªØ§Ø®Ø±", "ÙˆÙŠÙ†"]):
                if not delayed.empty:
                    c_list = delayed['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'].unique()
                    d_list = delayed['Ø§Ù„Ø³Ø§Ø¦Ù‚'].unique()
                    response = f"Ø£Ø³ØªØ§Ø° Ø·Ø§Ø±Ù‚ØŒ Ù‚Ù…Øª Ø¨ØªØ­Ù„ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙÙˆØ±Ø§Ù‹. **Ø§Ù„ØªØ£Ø®ÙŠØ± ÙŠØªØ±ÙƒØ² Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ: {', '.join(c_list)}**. \n\n"
                    response += f"Ù„Ø¯ÙŠÙ†Ø§ {len(delayed)} Ø´Ø­Ù†Ø§Øª Ù…ØªØ¹Ø«Ø±Ø©ØŒ ÙˆØ£Ø¨Ø±Ø² Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† Ù‡Ù… {', '.join(d_list[:2])}. \n\n"
                    response += "ğŸ’¡ **ØªØ­Ù„ÙŠÙ„ ÙˆØ­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø³ÙˆÙ‚):** \n"
                    response += "1. **Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Rerouting):** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¨Ø¨ Ø²Ø­Ø§Ù…Ø§Ù‹ Ù…Ø±ÙˆØ±ÙŠØ§Ù‹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ù†ØŒ Ø£Ù†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù†Ø¸Ù…Ø© Ø®Ø±Ø§Ø¦Ø· Ø­ÙŠØ© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹. \n"
                    response += "2. **Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª:** Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù€ VIP ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ¹Ø·Ù‰ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙÙŠ Ø£ÙˆÙ„ Ø´Ø§Ø­Ù†Ø© ØªØ®Ø±Ø¬ ØºØ¯Ø§Ù‹ Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø¶Ø±Ø±."
                else:
                    response = "ÙØ­ØµØª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„Ø› Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ£Ø®ÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØªØ³ÙŠØ± Ø¨ÙƒÙØ§Ø¡Ø© 100%."

            # Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ù†ØµÙŠØ­Ø© Ø£Ùˆ Ù†Ù‚Ø§Ø´ Ù…ÙØªÙˆØ­
            elif any(word in q for word in ["Ù†ØµÙŠØ­Ø©", "Ø±Ø§ÙŠÙƒ", "Ø³Ø§Ø¹Ø¯Ù†ÙŠ", "Ø§Ù‚ØªØ±Ø§Ø­", "Ø­Ù„"]):
                response = "Ø¨ØµÙØªÙŠ Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªÙŠØŒ Ù‚Ù…Øª Ø¨ØªØ­Ù„ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù ÙÙŠ Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ø¢Ù†: \n\n"
                if not low_stock.empty:
                    response += f"âš ï¸ **Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:** Ù„Ø¯ÙŠÙ†Ø§ Ù†Ù‚Øµ ÙÙŠ {low_stock.iloc[0]['Ø§Ù„Ù…Ù†ØªØ¬']}. Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ØŒ ÙŠÙÙ†ØµØ­ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… 'Just-in-Time' Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙØŒ Ù„ÙƒÙ† ÙÙŠ Ø­Ø§Ù„ØªÙ†Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ù†Ø§Ù‚Ù„Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù‡ÙŠ Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø³Ø±Ø¹. \n\n"
                response += "ğŸŒ **ØªØ·ÙˆÙŠØ± Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ:** Ù‡Ù„ ÙÙƒØ±Øª ÙÙŠ Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø£Ùˆ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø¯Ø¨ÙŠ ÙˆØ§Ù„Ø´Ø§Ø±Ù‚Ø© Ù…Ø¹ Ù†Ø¸Ø§Ù…Ù†Ø§ØŸ Ù‡Ø°Ø§ Ø³ÙŠØ¬Ø¹Ù„Ù†Ø§ Ù†ØªÙˆÙ‚Ø¹ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‚Ø¨Ù„ Ø­Ø¯ÙˆØ«Ù‡ Ø¨Ù€ 4 Ø³Ø§Ø¹Ø§Øª."

            # Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªØ­ÙŠØ© ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            elif any(word in q for word in ["Ø§Ù‡Ù„Ø§", "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ", "Ù…Ø±Ø­Ø¨Ø§"]):
                response = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø£Ø³ØªØ§Ø° Ø·Ø§Ø±Ù‚. Ø£Ù†Ø§ ÙÙŠ Ø­Ø§Ù„Ø© ØªØ£Ù‡Ø¨ Ù‚ØµÙˆÙ‰! Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¹Ø§Ù…ØŒ Ù„ÙƒÙ† Ø¹ÙŠÙ†ÙŠ Ø¹Ù„Ù‰ Ù…Ø¯ÙŠÙ†Ø© 'Ø§Ù„Ø¹ÙŠÙ†' Ù„ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ§Ø¯Ø± ØªØ£Ø®ÙŠØ± Ù‡Ù†Ø§Ùƒ. Ø¨Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† Ù†Ø¨Ø¯Ø£ Ù†Ù‚Ø§Ø´Ù†Ø§ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØŸ"

            else:
                response = "Ø£Ù†Ø§ Ù…Ø¹Ùƒ ØªÙ…Ø§Ù…Ø§Ù‹. ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù†Ù‚Ø§Ø´ Ø£ÙŠ Ø´ÙŠØ¡ Ù…Ù† ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªÙˆØ³Ø¹ ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ø²Ù†. Ø£Ø®Ø¨Ø±Ù†ÙŠ Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ"

            st.markdown(response)
            st.session_state.chat_history.append({"role": "assistant", "content": response})

# --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard) ---
st.markdown("<h1 style='text-align: center; color: #1E3A8A;'>ğŸ›ï¸ Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</h1>", unsafe_allow_html=True)

# ØµÙ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
k1, k2, k3, k4 = st.columns(4)
k1.metric("ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„", "92%", "2%+")
k2.metric("Ø´Ø§Ø­Ù†Ø§Øª Ù†Ø´Ø·Ø©", len(df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] != 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…']))
k3.metric("ØªØ£Ø®ÙŠØ±Ø§Øª Ø­Ø±Ø¬Ø© ğŸ”´", len(df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'Ù…ØªØ£Ø®Ø± ğŸ”´']), delta_color="inverse")
k4.metric("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø²Ù†", f"{df_inv['Ø§Ù„Ø±ØµÙŠØ¯'].sum():,}")

st.markdown("---")
t1, t2, t3 = st.tabs(["ğŸš› Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©", "ğŸ“¦ ØªÙˆØ§Ø²Ù† Ø§Ù„Ù…Ø®Ø§Ø²Ù†", "ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª"])

with t1:
    st.subheader("ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¯Ù† ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†")
    st.dataframe(df_ord, use_container_width=True)
with t2:
    st.subheader("Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª")
    st.dataframe(df_inv, use_container_width=True)
with t3:
    col_left, col_right = st.columns(2)
    with col_left:
        st.plotly_chart(px.pie(df_ord, names='Ø§Ù„Ø­Ø§Ù„Ø©', hole=0.4, title="ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…"), use_container_width=True)
    with col_right:
        st.plotly_chart(px.bar(df_inv, x='Ø§Ù„Ù…Ù†ØªØ¬', y='Ø§Ù„Ø±ØµÙŠØ¯', color='Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', barmode='group', title="ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"), use_container_width=True)