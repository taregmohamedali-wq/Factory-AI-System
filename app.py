import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np
from datetime import datetime

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©
st.set_page_config(page_title="AI Operations Hub", layout="wide")

# 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©
if 'db' not in st.session_state:
    prods = ['Cola 330ml', 'Cola 1.5L', 'Water 500ml', 'Flour 5kg', 'Pasta']
    whs = ['Ù…Ø³ØªÙˆØ¯Ø¹ Ø¯Ø¨ÙŠ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ', 'Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø´Ø§Ø±Ù‚Ø©']
    inv = []
    for p in prods:
        for w in whs:
            inv.append({'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹': w, 'Ø§Ù„Ù…Ù†ØªØ¬': p, 'Ø§Ù„Ø±ØµÙŠØ¯': np.random.randint(50, 4000)})
    
    drivers = ['Ø³Ø¹ÙŠØ¯ Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'Ø¬Ø§Ø³Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', 'Ø®Ø§Ù„Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†']
    cities = ['Ø¯Ø¨ÙŠ', 'Ø£Ø¨ÙˆØ¸Ø¨ÙŠ', 'Ø§Ù„Ø´Ø§Ø±Ù‚Ø©', 'Ø§Ù„Ø¹ÙŠÙ†', 'Ø§Ù„ÙØ¬ÙŠØ±Ø©']
    orders = []
    for i in range(1, 41):
        orders.append({
            'Ø§Ù„Ø¹Ù…ÙŠÙ„': f'Ø¹Ù…ÙŠÙ„ {i}',
            'Ø§Ù„Ø­Ø§Ù„Ø©': np.random.choice(['ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…', 'Ù…ØªØ£Ø®Ø± ğŸ”´', 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸšš']),
            'Ø§Ù„Ø³Ø§Ø¦Ù‚': np.random.choice(drivers),
            'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': np.random.choice(cities),
            'Ø§Ù„Ø£Ù‡Ù…ÙŠØ©': np.random.choice(['VIP (AAA)', 'High (AA)', 'Normal (A)']),
            'Ø§Ù„Ø´Ø§Ø­Ù†Ø©': f'TRK-{100+i}'
        })
    st.session_state.df_inv = pd.DataFrame(inv)
    st.session_state.df_orders = pd.DataFrame(orders)
    st.session_state.chat_history = [] 
    st.session_state.db = True

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
df_ord = st.session_state.df_orders
df_inv = st.session_state.df_inv

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: Ø¹Ù‚Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ChatGPT Style) ---
with st.sidebar:
    st.title("ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ (AI Manager)")
    st.markdown("---")
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    for msg in st.session_state.chat_history:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    if prompt := st.chat_input("ØªØ­Ø¯Ø« Ù…Ø¹ÙŠØŒ Ù†Ø§Ù‚Ø´Ù†ÙŠ ÙÙŠ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù†ØµÙŠØ­Ø©..."):
        st.session_state.chat_history.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        with st.chat_message("assistant"):
            q = prompt.lower()
            
            # Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ‚
            delayed = df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] == 'Ù…ØªØ£Ø®Ø± ğŸ”´']
            critical_inv = df_inv[df_inv['Ø§Ù„Ø±ØµÙŠØ¯'] < 500]
            vip_delayed = delayed[delayed['Ø§Ù„Ø£Ù‡Ù…ÙŠØ©'] == 'VIP (AAA)']

            # Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø°ÙƒÙŠ (Reasoning Engine)
            if any(word in q for word in ["Ø£ÙŠÙ†", "ØªØ§Ø®ÙŠØ±", "ØªØ§Ø®Ø±", "ÙˆÙŠÙ†", "Ù…Ø´ÙƒÙ„Ø©"]):
                response = f"Ø£Ù‡Ù„Ø§Ù‹ Ø£Ø³ØªØ§Ø° Ø·Ø§Ø±Ù‚. Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙÙˆØ±Ø§Ù‹. **Ù…ÙƒÙ…Ù† Ø§Ù„Ø®Ù„Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙŠØªØ±ÙƒØ² ÙÙŠ {len(delayed)} Ø´Ø­Ù†Ø§Øª Ù…ØªØ£Ø®Ø±Ø©.**\n\n"
                response += f"ØªØ­Ø¯ÙŠØ¯Ø§Ù‹ØŒ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© Ù‡ÙŠ: **{', '.join(delayed['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'].unique())}**. \n\n"
                if not vip_delayed.empty:
                    response += f"âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ:** Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„Ø§Ø¡ VIP Ù…ØªØ£Ø«Ø±ÙˆÙ† ÙÙŠ {vip_delayed['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'].iloc[0]}. Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠØ¶Ø± Ø¨Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø³Ù†ÙˆÙŠØ©.\n\n"
                response += "ğŸ’¡ **ØªØ­Ù„ÙŠÙ„ ÙˆØ­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©:**\n"
                response += "- **Ù„ÙˆØ¬Ø³ØªÙŠØ§Ù‹:** Ø£Ù†ØµØ­ Ø¨ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… 'Cross-Docking' Ù„ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‚Øª Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª.\n"
                response += "- **Ø¥Ø¯Ø§Ø±ÙŠØ§Ù‹:** ÙŠØ¬Ø¨ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ø§Ù„Ø³Ø¨Ø¨ ØªÙ‚Ù†ÙŠ Ø£Ù… Ù…Ø±ÙˆØ±ÙŠØŒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙˆØ±Ø§Ù‹."

            elif any(word in q for word in ["Ù†ØµÙŠØ­Ø©", "Ø±Ø§ÙŠÙƒ", "Ø­Ù„", "Ø§Ù‚ØªØ±Ø§Ø­", "ØªØ·ÙˆÙŠØ±"]):
                response = "Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø¡ØªÙŠ Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ØµÙ†Ø¹ ÙˆÙ…Ù‚Ø§Ø±Ù†ØªÙ‡Ø§ Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©ØŒ Ø¥Ù„ÙŠÙƒ ØªÙ‚Ø±ÙŠØ±ÙŠ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ:\n\n"
                response += f"1. **Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£Ù…Ø§Ù†:** Ù„Ø¯ÙŠÙ†Ø§ {len(critical_inv)} Ø£ØµÙ†Ø§Ù ØªØ­Øª Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†. Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù‡ÙƒØ°Ø§ ÙŠØ®Ø§Ø·Ø± Ø¨ÙˆÙ‚Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹.\n"
                response += "2. **ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù†Ù‚Ù„:** Ø£Ù‚ØªØ±Ø­ Ø¯Ù…Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¬Ù‡Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙÙŠ Ø´Ø§Ø­Ù†Ø© ÙˆØ§Ø­Ø¯Ø© (Load Optimization) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯.\n"
                response += "3. **Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§:** Ø£Ù†ØµØ­Ùƒ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ Ø¨ØªØ±ÙƒÙŠØ¨ Ø£Ø¬Ù‡Ø²Ø© ØªØªØ¨Ø¹ GPS Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø­Ø¸ÙŠØ§Ù‹."

            elif any(word in q for word in ["Ø§Ù‡Ù„Ø§", "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ", "Ù…Ø±Ø­Ø¨Ø§", "ÙŠØ§"):
                response = f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø³ÙŠØ¯ÙŠ. Ø£Ù†Ø§ Ø£Ø¹Ù…Ù„ Ø¨ÙƒØ§Ù…Ù„ Ø·Ø§Ù‚ØªÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©. Ø±ØµØ¯Øª Ø§Ù„ÙŠÙˆÙ… Ø£Ù† ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… ØªØ¨Ù„Øº {100 - (len(delayed)/len(df_ord)*100):.1f}%. Ù‡Ù†Ø§Ùƒ Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ† Ø®Ø§ØµØ© ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø©. Ø¨Ù…Ø§Ø°Ø§ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø¡ØŸ"

            else:
                response = "ÙÙ‡Ù…Øª Ø³ÙŠØ§Ù‚ Ø­Ø¯ÙŠØ«Ùƒ. Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø£ÙƒÙˆÙ† 'Ø¹Ù‚Ù„Ùƒ Ø§Ù„Ø«Ø§Ù†ÙŠ' ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù…Ù†Ø§Ù‚Ø´Ø© ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†ØŒ Ø£Ùˆ Ø¬Ø¯ÙˆÙ„Ø© Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ù…Ø®Ø§Ø²Ù†ØŒ Ø£Ùˆ Ø­ØªÙ‰ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬. Ù…Ø§Ø°Ø§ ØªÙ‚ØªØ±Ø­ØŸ"

            st.markdown(response)
            st.session_state.chat_history.append({"role": "assistant", "content": response})

# --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ) ---
st.markdown("<h1 style='text-align: center; color: #1E3A8A;'>ğŸ›ï¸ Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</h1>", unsafe_allow_html=True)

# ØµÙ Ø§Ù„Ù€ KPIs
k1, k2, k3, k4 = st.columns(4)
k1.metric("ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„", f"{100 - (len(delayed)/len(df_ord)*100):.1f}%")
k2.metric("Ø´Ø§Ø­Ù†Ø§Øª Ù†Ø´Ø·Ø©", len(df_ord[df_ord['Ø§Ù„Ø­Ø§Ù„Ø©'] != 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…']))
k3.metric("ØªØ£Ø®ÙŠØ±Ø§Øª Ø­Ø±Ø¬Ø© ğŸ”´", len(delayed), delta_color="inverse")
k4.metric("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø²Ù†", f"{df_inv['Ø§Ù„Ø±ØµÙŠØ¯'].sum():,}")

st.markdown("---")
t1, t2, t3 = st.tabs(["ğŸš› Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©", "ğŸ“¦ ØªÙˆØ§Ø²Ù† Ø§Ù„Ù…Ø®Ø§Ø²Ù†", "ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ù†Ù…Ùˆ"])

with t1:
    st.dataframe(df_ord.sort_values(by='Ø§Ù„Ø£Ù‡Ù…ÙŠØ©'), use_container_width=True)
with t2:
    st.dataframe(df_inv, use_container_width=True)
with t3:
    c_l, c_r = st.columns(2)
    with c_l:
        st.plotly_chart(px.pie(df_ord, names='Ø§Ù„Ø­Ø§Ù„Ø©', hole=0.4, title="ØªØ­Ù„ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ"), use_container_width=True)
    with c_r:
        st.plotly_chart(px.bar(df_inv, x='Ø§Ù„Ù…Ù†ØªØ¬', y='Ø§Ù„Ø±ØµÙŠØ¯', color='Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', barmode='group', title="ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ"), use_container_width=True)